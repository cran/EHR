<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>EHR Vignette for Structured Data</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">EHR Vignette for Structured Data</h1>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The <code>EHR</code> package provides several modules to perform diverse medication-related studies using data from electronic health record (EHR) databases. Especially, the package includes modules to perform pharmacokinetic/pharmacodynamic (PK/PD) analyses using EHRs, as outlined in Choi <em>et al.</em><span class="math inline">\(^{1}\)</span>, and additional modules will be added in the future. This vignette describes four modules for processing data (<em>Pro-Demographic</em>, <em>Pro-Med-Str</em>, <em>Pro-Drug Level</em>, <em>Pro-Laboratory</em>) and one module for PK data building (<em>Build-PK-IV</em>) in the system, when data are typically obtained from a structured database.</p>
<p>The process starts with structured data extracted by Structured Query Language (SQL) from EHRs or provided by a user, then moves through two phases: data processing which standardizes and combines the input data (<em>Pro-Med-Str</em>, <em>Pro-Drug Level</em>, etc.) and data building which creates the final PK data (<em>Build-PK-IV</em>).</p>
<p>The vignette has two examples. The first example demonstrates how to build PK data quickly without using the data processing modules when cleaned data for concentration, drug dose, demographic and laboratory datasets are already available in an appropriate data form. The second example shows how to utilize several data processing modules to standardize and combine more complex datasets, and then finally build PK data using <em>Build-PK-IV</em>.</p>
<p>To begin we load the <code>EHR</code> package, the <code>pkdata</code> package, and the <code>lubridate</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load EHR package and dependencies</span>
<span class="kw">library</span>(EHR)
<span class="kw">library</span>(pkdata)
<span class="kw">library</span>(lubridate)</code></pre></div>
</div>
<div id="example-1-quick-data-building-with-processed-datasets" class="section level1">
<h1>Example 1: Quick Data Building with Processed Datasets</h1>
<p>The data for example 1 includes a demographic file, a concentration file, an intravenous (IV) dosing file, and a laboratory file, which are all cleaned and formatted appropriately. We also define a directory for the raw data and a directory for interactive checking output files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define directories</span>
td &lt;-<span class="st"> </span><span class="kw">tempdir</span>()
<span class="kw">dir.create</span>(<span class="kw">file.path</span>(td, <span class="st">'check1'</span>))
rawDataDir &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;examples&quot;</span>, <span class="st">&quot;str_ex1&quot;</span>, <span class="dt">package=</span><span class="st">&quot;EHR&quot;</span>)
checkDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(td, <span class="st">'check1'</span>)

demo &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir,<span class="st">&quot;Demographics_DATA_simple.csv&quot;</span>))
<span class="kw">head</span>(demo)</code></pre></div>
<pre><code>##   patient_id patient_visit_id gender weight height surgery_date ageatsurgery
## 1          2              2.1      1  62.99 179.72    6/20/2015         6245
## 2          3              3.1      0   7.71  72.99   12/15/2018          574
## 3          4              4.1      1  12.00  92.02    1/12/2018         1214
## 4          5              5.1      0   5.89  56.13    5/13/2018          102
## 5          6              6.2      1   7.90  63.31    9/24/2018          343
## 6          6              6.1      1   6.16  60.89    5/26/2018          222
##   stat_sts cpb_sts date_icu_dc time_fromor length_of_icu_stay
## 1        2      80   6/22/2015          NA                  2
## 2        3      67  12/16/2018          NA                  1
## 3        1      70   1/13/2018          NA                  1
## 4        1     151   5/14/2018        1427                  1
## 5        2      50   10/6/2018          NA                 12
## 6        4      99   8/13/2018        1958                 79</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">conc.data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir,<span class="st">&quot;Concentration_DATA_simple.csv&quot;</span>))
<span class="kw">head</span>(conc.data)</code></pre></div>
<pre><code>##   patient_id patient_visit_id event conc.level           date.time
## 1         10             10.1     4       0.17 2019-02-02 05:30:00
## 2         10             10.1     2       4.05 2019-02-24 14:00:00
## 3         10             10.1     3       0.64 2019-02-25 03:30:00
## 4         10             10.1     5       0.33 2019-02-27 02:45:00
## 5         10             10.1     6       0.07 2019-02-28 03:30:00
## 6         10             10.1     7       0.05 2019-03-01 02:35:00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ivdose.data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir,<span class="st">&quot;IVDose_DATA_simple.csv&quot;</span>))
<span class="kw">head</span>(ivdose.data)</code></pre></div>
<pre><code>##   patient_id  date.dose    infuse.time.real         infuse.time infuse.dose
## 1          1 2009-10-18 2009-10-18 11:35:00 2009-10-18 12:00:00         8.8
## 2          1 2009-10-18 2009-10-18 12:00:00 2009-10-18 12:00:00         8.8
## 3          1 2009-10-18 2009-10-18 13:00:00 2009-10-18 13:00:00         8.8
## 4          1 2009-10-18 2009-10-18 14:00:00 2009-10-18 14:00:00         8.8
## 5          1 2009-10-18 2009-10-18 15:00:00 2009-10-18 15:00:00         8.8
## 6          1 2009-10-18 2009-10-18 16:00:00 2009-10-18 16:00:00         8.8
##   bolus.time bolus.dose given.dose maxint weight
## 1       &lt;NA&gt;         NA          0     60    4.4
## 2       &lt;NA&gt;         NA          0     60    4.4
## 3       &lt;NA&gt;         NA          0     60    4.4
## 4       &lt;NA&gt;         NA          0     60    4.4
## 5       &lt;NA&gt;         NA          0     60    4.4
## 6       &lt;NA&gt;         NA          0     60    4.4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">creat.data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir,<span class="st">&quot;Creatinine_DATA_simple.csv&quot;</span>))
<span class="kw">head</span>(creat.data)</code></pre></div>
<pre><code>##   patient_id           date.time creat
## 1          2 2015-06-23 04:35:00  0.75
## 2          2 2015-06-22 04:00:00  0.69
## 3          2 2015-06-21 01:55:00  0.78
## 4          2 2015-06-24 03:45:00  0.64
## 5          2 2015-06-14 15:11:00  0.71
## 6          2 2015-06-20 20:14:00  0.58</code></pre>
<p>The <code>EHR</code> package modules use a standardized naming convention for patient identification (ID) variables. We rename the unique patient-level ID from <code>patient_id</code> to <code>mod_id</code> and the visit-level ID from <code>patient_visit_id</code> to <code>mod_id_visit</code>. If there is only a single visit/course per subject the unique patient-level ID and visit-level ID can be the same, however both <code>mod_id</code> and <code>mod_id_visit</code> should be defined.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(conc.data)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">names</span>(demo)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;mod_id&quot;</span>, <span class="st">&quot;mod_id_visit&quot;</span>)
<span class="kw">names</span>(creat.data)[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">names</span>(ivdose.data)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;mod_id&quot;</span></code></pre></div>
<p>Using the four datasets, we can build a final PK dataset with the function <code>run_Build_PK_IV()</code>. Additional details for this function are provided below in the <em>Build-PK-IV</em> subsection of Example 2: Complete Data Processing and Building from Raw Extracted Data to PK Data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simple_pk_dat &lt;-<span class="st"> </span><span class="kw">run_Build_PK_IV</span>(
    <span class="dt">conc=</span>conc.data,
    <span class="dt">dose=</span>ivdose.data,
    <span class="dt">lab.dat =</span> <span class="kw">list</span>(creat.data),
    <span class="dt">lab.vars =</span> <span class="kw">c</span>(<span class="st">'creat'</span>),
    <span class="dt">demo.list =</span> demo,
    <span class="dt">demo.vars=</span><span class="kw">c</span>(<span class="st">'weight'</span>, <span class="st">'weight_demo'</span>, <span class="st">'height'</span>, <span class="st">'gender'</span>, <span class="st">'ageatsurgery'</span>,
                <span class="st">'stat_sts'</span>, <span class="st">'cpb_sts'</span>, <span class="st">'length_of_icu_stay'</span>),
    <span class="dt">demo.abbr=</span><span class="kw">c</span>(<span class="st">'wgt'</span>, <span class="st">'wgt_demo'</span>, <span class="st">'height'</span>, <span class="st">'gender'</span>,
                <span class="st">'age'</span>, <span class="st">'stat'</span>, <span class="st">'cpb'</span>, <span class="st">'loi'</span>),
    <span class="dt">pk.vars=</span><span class="kw">c</span>(<span class="st">'mod_id_visit'</span>, <span class="st">'time'</span>, <span class="st">'conc'</span>, <span class="st">'dose'</span>, <span class="st">'rate'</span>, <span class="st">'event'</span>,
              <span class="st">'other'</span>, <span class="st">'multiple.record'</span>, <span class="st">'date'</span>, <span class="st">'mod_id'</span>),
    <span class="dt">drugname=</span><span class="st">'fent'</span>,
    <span class="dt">check.path=</span>checkDir)</code></pre></div>
<pre><code>## 0 duplicated rows
## The dimension of the PK data before merging with demographics: 149 x 9
## The number of subjects in the PK data before merging with demographics: 10
## The number of subjects in the demographic file, who meet the exclusion 
##      criteria: 0
## check NA frequency in demographics, see file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check1/fent-missing-demo.csv
## List of IDs missing at least 1 cpb_sts: 
## Checked: all missing cpb_sts are 0
## The list of final demographic variables: weight
## weight_demo
## height
## gender
## ageatsurgery
## stat_sts
## cpb_sts
## length_of_icu_stay
## Checked: there are no missing creat
## The dimension of the final PK data exported with the key demographics: 
##      149 x 16 with 10 distinct subjects (mod_id_visit)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(simple_pk_dat,<span class="dv">15</span>)</code></pre></div>
<pre><code>##    mod_id_visit  time conc amt rate mdv evid   wgt wgt_demo height gender  age
## 1           1.2  0.00   NA  50    0   1    1 25.04    25.04 114.39      1 2295
## 2           1.2  0.75   NA 100    0   1    1 25.04    25.04 114.39      1 2295
## 3           1.2  1.65   NA 100    0   1    1 25.04    25.04 114.39      1 2295
## 4           1.2  1.77   NA 250    0   1    1 25.04    25.04 114.39      1 2295
## 5           1.2  2.05   NA 250    0   1    1 25.04    25.04 114.39      1 2295
## 6           1.2  3.72   NA 250    0   1    1 25.04    25.04 114.39      1 2295
## 7           1.2  5.23   NA 100    0   1    1 25.04    25.04 114.39      1 2295
## 8           1.2  6.25 2.83  NA   NA   0    0 25.04    25.04 114.39      1 2295
## 9           1.2 20.68 0.41  NA   NA   0    0 25.04    25.04 114.39      1 2295
## 10          1.2 70.90 0.04  NA   NA   0    0 25.04    25.04 114.39      1 2295
## 11          1.2 95.25 0.01  NA   NA   0    0 25.04    25.04 114.39      1 2295
## 12         10.1  0.00   NA  25    0   1    1  6.06     6.06  63.20      0  209
## 13         10.1  0.52   NA 100    0   1    1  6.06     6.06  63.20      0  209
## 14         10.1  1.42   NA  25    0   1    1  6.06     6.06  63.20      0  209
## 15         10.1  2.77   NA  50    0   1    1  6.06     6.06  63.20      0  209
##    stat cpb loi creat
## 1     2  79   1  0.60
## 2     2  79   1  0.60
## 3     2  79   1  0.60
## 4     2  79   1  0.60
## 5     2  79   1  0.60
## 6     2  79   1  0.60
## 7     2  79   1  0.60
## 8     2  79   1  0.60
## 9     2  79   1  0.50
## 10    2  79   1  0.54
## 11    2  79   1  0.57
## 12    1 195   5  0.64
## 13    1 195   5  0.64
## 14    1 195   5  0.64
## 15    1 195   5  0.64</code></pre>
</div>
<div id="example-2-complete-data-processing-and-building-from-raw-extracted-data-to-pk-data" class="section level1">
<h1>Example 2: Complete Data Processing and Building from Raw Extracted Data to PK Data</h1>
<p>To begin example 2 we define three directories for the raw data, the processed data, and files used for interactive checking.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir.create</span>(<span class="kw">file.path</span>(td, <span class="st">'data2'</span>))
<span class="kw">dir.create</span>(<span class="kw">file.path</span>(td, <span class="st">'check2'</span>))
rawDataDir &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;examples&quot;</span>, <span class="st">&quot;str_ex2&quot;</span>, <span class="dt">package=</span><span class="st">&quot;EHR&quot;</span>)
dataDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(td, <span class="st">'data2'</span>)
checkDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(td, <span class="st">'check2'</span>)</code></pre></div>
<div id="pre-processing-for-raw-extracted-data" class="section level2">
<h2>Pre-Processing for Raw Extracted Data</h2>
<p>The raw data for example 2 includes a demographic file for use with the <em>Pro-Demographic</em> module; two files for the <em>Pro-Drug Level</em> module; two dosing files for the <em>Pro-Med-Str</em> module; and two lab files for use with the <em>Pro-Laboratory</em> module.</p>
<p>The structured datasets extracted by SQL must go through a pre-processing stage which creates new ID variables and datasets that can be used by the data processing modules. The following annotated example demonstrates the three main steps of pre-processing: (1) read and clean raw data; (2) merge raw data to create new ID variables; (3) make new data for use with modules.</p>
<p>Each raw dataset should contain a subject unique ID, a subject visit ID, or both ids. In this example the subject unique ID is called <code>subject_uid</code> and the subject visit ID is called <code>subject_id</code>. The subject visit ID is a combination of subject and visit/course -- e.g., <code>subject_id</code> 14.0 is the first course for subject 14, <code>subject_id</code> 14.1 is the second course for subject 14, and so on. <code>subject_uid</code> is a unique ID that is the same for all subject records. The integer part of <code>subject_id</code> has a 1-to-1 correspondence with <code>subject_uid</code> -- for this example, <code>subject_uid</code> 62734832 is associated with both <code>subject_id</code> 14.0 and <code>subject_id</code> 14.1. If there is only a single visit/course per subject only the subject unique ID is needed.</p>
<div id="read-and-clean-raw-data" class="section level3">
<h3>(1) Read and clean raw data</h3>
<p>The demographics data file contains ID variables <code>subject_id</code> and <code>subject_uid</code>, in addition to demographic variables such as gender, date of birth, height, weight, etc. The Demographics_DATA.csv file is read in using the <code>readTransform()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># demographics data</span>
demo.in &lt;-<span class="st"> </span><span class="kw">readTransform</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;Demographics_DATA.csv&quot;</span>))
<span class="kw">head</span>(demo.in)</code></pre></div>
<pre><code>##   subject_id subject_uid gender weight height surgery_date ageatsurgery
## 1       1106    34364670      0   5.14  59.18    6/28/2014          141
## 2       1444    36792472      1   5.67  62.90    1/10/2016          292
## 3       1465    36292449      0  23.67 118.02    3/19/2016         2591
## 4       1520    34161967      0  14.07  97.04    7/18/2016         1320
## 5       1524    37857374      1  23.40 102.80    7/23/2016         1561
## 6       1550    37826262      1   6.21  62.03     9/4/2016          208
##   stat_sts cpb_sts in_hospital_mortality add_ecmo date_icu_dc time_fromor
## 1        3     133                     0        0    7/2/2014        1657
## 2        1      65                     0        0   1/12/2016        1325
## 3        2     357                     0        0   3/20/2016          NA
## 4        5      93                     0        0   7/19/2016        1745
## 5        3      87                     1        0   7/30/2016        1847
## 6        1     203                     0        0   9/11/2016        1210</code></pre>
<p>The example concentration data consists of two files, SampleTimes_DATA.csv and SampleConcentration_DATA.csv containing the concentration sampling times and values, respectively.</p>
<p>The sampling times data csv file is read in with <code>read.csv()</code>. Then the function <code>dataTransformation()</code> is used to rename the variable <code>Study.ID</code> to <code>subject_id</code> and to create a new variable called <code>samp</code>, which indexes the sample number, using the <code>modify=</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># concentration sampling times data</span>
<span class="co"># read in raw data</span>
samp.raw &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;SampleTimes_DATA.csv&quot;</span>))
<span class="kw">head</span>(samp.raw)</code></pre></div>
<pre><code>##   Study.ID Event.Name Sample.Collection.Date.and.Time
## 1    466.1   Sample 1                  2/3/2017 10:46
## 2    466.1   Sample 2                  2/4/2017 20:30
## 3   1106.0   Sample 1                 6/28/2014 13:40
## 4   1106.0   Sample 2                 6/29/2014 03:10
## 5   1106.0   Sample 3                 6/30/2014 03:35
## 6   1106.0   Sample 4                  7/1/2014 03:45</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># transform data</span>
samp.in0 &lt;-<span class="st"> </span><span class="kw">dataTransformation</span>(samp.raw,
    <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'Study.ID'</span> =<span class="st"> 'subject_id'</span>),
    <span class="dt">modify =</span> <span class="kw">list</span>(<span class="dt">samp =</span> <span class="kw">expression</span>(<span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">'Sample '</span>, <span class="st">''</span>, Event.Name)))))
<span class="kw">head</span>(samp.in0)</code></pre></div>
<pre><code>##   subject_id Event.Name Sample.Collection.Date.and.Time samp
## 1      466.1   Sample 1                  2/3/2017 10:46    1
## 2      466.1   Sample 2                  2/4/2017 20:30    2
## 3     1106.0   Sample 1                 6/28/2014 13:40    1
## 4     1106.0   Sample 2                 6/29/2014 03:10    2
## 5     1106.0   Sample 3                 6/30/2014 03:35    3
## 6     1106.0   Sample 4                  7/1/2014 03:45    4</code></pre>
<p>Equivalently, the function <code>readTransform()</code> can be used to read in and transform the data with a single function call.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># read in and transform data</span>
samp.in &lt;-<span class="st"> </span><span class="kw">readTransform</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;SampleTimes_DATA.csv&quot;</span>),
    <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'Study.ID'</span> =<span class="st"> 'subject_id'</span>),
    <span class="dt">modify =</span> <span class="kw">list</span>(<span class="dt">samp =</span> <span class="kw">expression</span>(<span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">'Sample '</span>, <span class="st">''</span>, Event.Name)))))
<span class="kw">head</span>(samp.in)</code></pre></div>
<pre><code>##   subject_id Event.Name Sample.Collection.Date.and.Time samp
## 1      466.1   Sample 1                  2/3/2017 10:46    1
## 2      466.1   Sample 2                  2/4/2017 20:30    2
## 3     1106.0   Sample 1                 6/28/2014 13:40    1
## 4     1106.0   Sample 2                 6/29/2014 03:10    2
## 5     1106.0   Sample 3                 6/30/2014 03:35    3
## 6     1106.0   Sample 4                  7/1/2014 03:45    4</code></pre>
<p>The same steps can be used for the sample values data csv file. It is read in using <code>read.csv()</code>. Then using <code>dataTransformation()</code> the <code>subject_id</code> variable is created from the <code>name</code> variable using a call to the helper function <code>sampId()</code> in the <code>modify=</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># concentration sample values data</span>
<span class="co"># read in raw data</span>
conc.raw&lt;-<span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;SampleConcentration_DATA.csv&quot;</span>))
<span class="kw">head</span>(conc.raw)</code></pre></div>
<pre><code>##   record_id    name fentanyl_calc_conc
## 1         1 466.1_1         0.01413622
## 2         2 466.1_2         0.27982075
## 3         3  1106_1         6.11873679
## 4         4  1106_2         0.59161716
## 5         5  1106_3         0.11280471
## 6         6  1106_4         0.02112153</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># helper function used to make subject_id</span>
sampId &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  <span class="co"># remove leading zeroes or trailing periods</span>
  subid &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">'(^0*|</span><span class="ch">\\</span><span class="st">.$)'</span>, <span class="st">''</span>, x)
  <span class="co"># change _ to .</span>
  <span class="kw">gsub</span>(<span class="st">'_([0-9]+[_].*)$'</span>, <span class="st">'.</span><span class="ch">\\</span><span class="st">1'</span>, subid)
}

<span class="co"># transform data</span>
conc.in0 &lt;-<span class="st"> </span><span class="kw">dataTransformation</span>(conc.raw,
                    <span class="dt">modify =</span> <span class="kw">list</span>(
                    <span class="dt">subid =</span> <span class="kw">expression</span>(<span class="kw">sampId</span>(name)),
                    <span class="dt">subject_id =</span> <span class="kw">expression</span>(<span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">'[_].*'</span>, <span class="st">''</span>, subid))),
                    <span class="dt">samp =</span> <span class="kw">expression</span>(<span class="kw">sub</span>(<span class="st">'[^_]*[_]'</span>, <span class="st">''</span>, subid)),
                    <span class="dt">name =</span> <span class="ot">NULL</span>,
                    <span class="dt">data_file =</span> <span class="ot">NULL</span>,
                    <span class="dt">subid =</span> <span class="ot">NULL</span>
                    )
                  )
<span class="kw">head</span>(conc.in0)</code></pre></div>
<pre><code>##   record_id fentanyl_calc_conc subject_id samp
## 1         1         0.01413622      466.1    1
## 2         2         0.27982075      466.1    2
## 3         3         6.11873679     1106.0    1
## 4         4         0.59161716     1106.0    2
## 5         5         0.11280471     1106.0    3
## 6         6         0.02112153     1106.0    4</code></pre>
<p>Again, we can perform the same two steps with a single call to <code>readTransform()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># equivalent using readTransform()</span>
conc.in &lt;-<span class="st"> </span><span class="kw">readTransform</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;SampleConcentration_DATA.csv&quot;</span>),
  <span class="dt">modify =</span> <span class="kw">list</span>(
    <span class="dt">subid =</span> <span class="kw">expression</span>(<span class="kw">sampId</span>(name)),
    <span class="dt">subject_id =</span> <span class="kw">expression</span>(<span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">'[_].*'</span>, <span class="st">''</span>, subid))),
    <span class="dt">samp =</span> <span class="kw">expression</span>(<span class="kw">sub</span>(<span class="st">'[^_]*[_]'</span>, <span class="st">''</span>, subid)),
    <span class="dt">name =</span> <span class="ot">NULL</span>,
    <span class="dt">data_file =</span> <span class="ot">NULL</span>,
    <span class="dt">subid =</span> <span class="ot">NULL</span>
    )
  )
<span class="kw">head</span>(conc.in)</code></pre></div>
<pre><code>##   record_id fentanyl_calc_conc subject_id samp
## 1         1         0.01413622      466.1    1
## 2         2         0.27982075      466.1    2
## 3         3         6.11873679     1106.0    1
## 4         4         0.59161716     1106.0    2
## 5         5         0.11280471     1106.0    3
## 6         6         0.02112153     1106.0    4</code></pre>
<p>The example drug dosing data consists of files FLOW_DATA.csv and MAR_DATA.csv containing two sources of IV dose information. The FLOW data csv file contains aliases for both ID variables; it is read in with the <code>readTransform()</code> function which renames the variables <code>Subject.Id</code> to <code>subject_id</code> and <code>Subject.Uniq.Id</code> to <code>subject_uid</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># FLOW dosing data</span>
flow.in &lt;-<span class="st"> </span><span class="kw">readTransform</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;FLOW_DATA.csv&quot;</span>),
                         <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'Subject.Id'</span> =<span class="st"> 'subject_id'</span>,
                                    <span class="st">'Subject.Uniq.Id'</span> =<span class="st"> 'subject_uid'</span>)) 
<span class="kw">head</span>(flow.in)</code></pre></div>
<pre><code>##   subject_id subject_uid     Perform.Date FOCUS_MEDNAME Final.Wt..kg.
## 1       1596    38340814   12/4/2016 5:30      Fentanyl          6.75
## 2       1596    38340814   12/4/2016 6:00      Fentanyl          6.75
## 3       1596    38340814   12/4/2016 7:00      Fentanyl          6.75
## 4       1596    38340814   12/4/2016 7:40      Fentanyl          6.75
## 5       1607    38551767 12/24/2016 19:30      Fentanyl          2.60
## 6       1607    38551767 12/24/2016 20:00      Fentanyl          2.60
##   Final.Rate..NFR.units. Final.Units Flow
## 1            1 mcg/kg/hr       3.375   NA
## 2            1 mcg/kg/hr       6.750  0.1
## 3            1 mcg/kg/hr       4.500  0.1
## 4            0 mcg/kg/hr       0.000   NA
## 5            2 mcg/kg/hr       2.600   NA
## 6            2 mcg/kg/hr       5.200  0.2</code></pre>
<p>The MAR data csv file contains several variables with a colon (:) character. To preserve the colon in these variable names, the data can be read in without checking for syntactically valid <code>R</code> variable names. The data is read in using <code>read.csv()</code> with the argument <code>check.names = FALSE</code> and then passed to the <code>dataTransformation()</code> function which renames <code>Uniq.Id</code> to <code>subject_uid</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># MAR dosing data</span>
mar.in0 &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;MAR_DATA.csv&quot;</span>), <span class="dt">check.names =</span> <span class="ot">FALSE</span>)
mar.in &lt;-<span class="st"> </span><span class="kw">dataTransformation</span>(mar.in0, <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'Uniq.Id'</span> =<span class="st"> 'subject_uid'</span>))
<span class="kw">head</span>(mar.in)</code></pre></div>
<pre><code>##   subject_uid       Date  Time                 med:mDrug   med:dosage med:route
## 1    28579217 2017-02-04 19:15               Nicardipine 3 mcg/kg/min        IV
## 2    28579217 2011-10-02 22:11                Famotidine       4.5 mg        IV
## 3    28579217 2011-10-02 20:17          Morphine sulfate         1 mg        IV
## 4    28579217 2011-10-03 02:28 Diphenhydramine injection        12 mg        IV
## 5    28579217 2011-10-02 22:11                 Cefazolin       225 mg        IV
## 6    28579217 2011-10-02 23:30          Morphine sulfate         1 mg        IV
##   med:freq med:given
## 1     &lt;NA&gt;     Given
## 2   q12hrs     Given
## 3  q2h prn     Given
## 4      now     Given
## 5    q8hrs     Given
## 6  q2h prn     Given</code></pre>
<p>The example laboratory data consists of files Creatinine_DATA.csv and Albumin_DATA.csv. Both files are read in using the <code>readTransform()</code> function and <code>Subject.uniq</code> is renamed to <code>subject_uid</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Serum creatinine lab data</span>
creat.in &lt;-<span class="st"> </span><span class="kw">readTransform</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;Creatinine_DATA.csv&quot;</span>),
    <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'Subject.uniq'</span> =<span class="st"> 'subject_uid'</span>))
<span class="kw">head</span>(creat.in)</code></pre></div>
<pre><code>##   subject_uid     date time creat
## 1    28579217 02/05/17 4:00  0.52
## 2    28579217 02/06/17 5:00  0.53
## 3    28579217 10/03/11 4:28  0.42
## 4    28579217 10/04/11 4:15  0.35
## 5    28579217 10/06/11 4:25  0.29
## 6    28579217 10/09/11 4:45  0.28</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Albumin lab data</span>
alb.in &lt;-<span class="st"> </span><span class="kw">readTransform</span>(<span class="kw">file.path</span>(rawDataDir, <span class="st">&quot;Albumin_DATA.csv&quot;</span>),
    <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'Subject.uniq'</span> =<span class="st"> 'subject_uid'</span>))
<span class="kw">head</span>(creat.in)</code></pre></div>
<pre><code>##   subject_uid     date time creat
## 1    28579217 02/05/17 4:00  0.52
## 2    28579217 02/06/17 5:00  0.53
## 3    28579217 10/03/11 4:28  0.42
## 4    28579217 10/04/11 4:15  0.35
## 5    28579217 10/06/11 4:25  0.29
## 6    28579217 10/09/11 4:45  0.28</code></pre>
</div>
<div id="merge-data-to-create-new-id-variables" class="section level3">
<h3>(2) Merge data to create new ID variables</h3>
<p>The function <code>idCrosswalk()</code> merges all of the cleaned input datasets and creates new IDs. The <code>data=</code> argument of this function accepts a list of input datasets and the <code>idcols=</code> argument accepts a list of vectors or character strings that identify the ID variables in the corresponding input dataset.</p>
<p>The output of <code>idCrosswalk()</code> is a crosswalk dataset between the original ID variables (<code>subject_id</code>, <code>subject_uid</code>) and the new ID variables (<code>mod_id</code>, <code>mod_visit</code>, and <code>mod_id_visit</code>). The new variable <code>mod_id_visit</code> has a 1-to-1 correspondence to variable <code>subject_id</code> and uniquely identifies each subjects' visit/course; the new variable <code>mod_id</code> has a 1-to-1 correspondence to variable <code>subject_uid</code> and uniquely identifies each subject.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># merge all ID datasets</span>
data &lt;-<span class="st">  </span><span class="kw">list</span>(demo.in,
              samp.in,
              conc.in,
              flow.in,
              mar.in,
              creat.in,
              alb.in)

idcols &lt;-<span class="st">  </span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">'subject_id'</span>, <span class="st">'subject_uid'</span>), <span class="co"># id vars in demo.in</span>
                <span class="st">'subject_id'</span>, <span class="co"># id var in samp.in</span>
                <span class="st">'subject_id'</span>, <span class="co"># id var in conc.in</span>
                <span class="kw">c</span>(<span class="st">'subject_id'</span>, <span class="st">'subject_uid'</span>), <span class="co"># id vars in flow.in</span>
                <span class="st">'subject_uid'</span>, <span class="co"># id var in mar.in</span>
                <span class="st">'subject_uid'</span>, <span class="co"># id var in creat.in</span>
                <span class="st">'subject_uid'</span>) <span class="co"># id var in creat.in</span>

mod.id &lt;-<span class="st"> </span><span class="kw">idCrosswalk</span>(data, idcols, <span class="dt">visit.id=</span><span class="st">&quot;subject_id&quot;</span>, <span class="dt">uniq.id=</span><span class="st">&quot;subject_uid&quot;</span>)
<span class="kw">saveRDS</span>(mod.id, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_module_id.rds&quot;</span>))

mod.id</code></pre></div>
<pre><code>##    subject_id subject_uid mod_visit mod_id mod_id_visit
## 1       466.0    28579217         1      1          1.1
## 2       466.1    28579217         2      1          1.2
## 3      1106.0    34364670         1      2          2.1
## 4      1444.0    36792472         1      3          3.1
## 5      1465.0    36292449         1      4          4.1
## 6      1520.0    34161967         1      5          5.1
## 7      1524.0    37857374         1      6          6.1
## 8      1550.0    37826262         1      7          7.1
## 9      1566.0    35885929         1      8          8.1
## 10     1566.1    35885929         2      8          8.2
## 11     1596.0    38340814         1      9          9.1
## 12     1607.0    38551767         1     10         10.1
## 13     1607.1    38551767         2     10         10.2
## 14     1724.0    39087607         1     11         11.1
## 15     1770.0    39418554         1     12         12.1
## 16     1770.1    39418554         2     12         12.2
## 17     2157.0    42023523         1     13         13.1
## 18     2162.0    42044808         1     14         14.1
## 19     2164.0    41221120         1     15         15.1</code></pre>
</div>
<div id="make-new-data-for-use-with-modules" class="section level3">
<h3>(3) Make new data for use with modules</h3>
<p>The function <code>pullFakeId()</code> replaces the original IDs -- <code>subject_id</code> and <code>subject_uid</code> -- with new IDs -- <code>mod_id</code>, <code>mod_visit</code>, and <code>mod_id_visit</code> -- to create datasets which can be used by the data processing modules. Generally, the function call to <code>pullFakeId()</code> is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">pullFakeId</span>(dat, xwalk, <span class="dt">firstCols =</span> <span class="ot">NULL</span>, <span class="dt">orderBy =</span> <span class="ot">NULL</span>)</code></pre></div>
<p>The <code>dat=</code> argument should contain the cleaned input data.frame from pre-processing step (1) and the <code>xwalk=</code> argument should contain the crosswalk data.frame produced in step (2). Additional arguments <code>firstCols=</code> and <code>orderBy=</code> control which variables are in the first columns of the output and the sort order, respectively. The cleaned structured data are saved as <code>R</code> objects for use with the modules.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## demographics data
demo.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(demo.in, mod.id,
    <span class="dt">firstCols =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>, <span class="st">'mod_visit'</span>, <span class="st">'mod_id_visit'</span>),
    <span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(demo.cln)</code></pre></div>
<pre><code>##   mod_id mod_visit mod_id_visit gender weight height surgery_date ageatsurgery
## 1      2         1          2.1      0   5.14  59.18    6/28/2014          141
## 2      3         1          3.1      1   5.67  62.90    1/10/2016          292
## 3      4         1          4.1      0  23.67 118.02    3/19/2016         2591
## 4      5         1          5.1      0  14.07  97.04    7/18/2016         1320
## 5      6         1          6.1      1  23.40 102.80    7/23/2016         1561
## 6      7         1          7.1      1   6.21  62.03     9/4/2016          208
##   stat_sts cpb_sts in_hospital_mortality add_ecmo date_icu_dc time_fromor
## 1        3     133                     0        0    7/2/2014        1657
## 2        1      65                     0        0   1/12/2016        1325
## 3        2     357                     0        0   3/20/2016          NA
## 4        5      93                     0        0   7/19/2016        1745
## 5        3      87                     1        0   7/30/2016        1847
## 6        1     203                     0        0   9/11/2016        1210</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(demo.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_demo_mod_id.rds&quot;</span>))

## drug level data
<span class="co"># sampling times</span>
samp.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(samp.in, mod.id,
    <span class="dt">firstCols =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>, <span class="st">'mod_visit'</span>, <span class="st">'mod_id_visit'</span>, <span class="st">'samp'</span>), 
    <span class="dt">orderBy =</span> <span class="kw">c</span>(<span class="st">'mod_id_visit'</span>,<span class="st">'samp'</span>),
    <span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(samp.cln)</code></pre></div>
<pre><code>##   mod_id mod_visit mod_id_visit samp Event.Name Sample.Collection.Date.and.Time
## 1      1         2          1.2    1   Sample 1                  2/3/2017 10:46
## 2      1         2          1.2    2   Sample 2                  2/4/2017 20:30
## 3     10         1         10.1    1   Sample 1                12/23/2016 05:15
## 4     10         1         10.1    2   Sample 2                12/24/2016 18:00
## 5     10         1         10.1    3   Sample 3                12/25/2016 03:00
## 6     10         1         10.1    4   Sample 4                12/26/2016 04:00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(samp.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_samp_mod_id.rds&quot;</span>))

<span class="co"># sampling concentrations</span>
conc.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(conc.in, mod.id,
    <span class="dt">firstCols =</span> <span class="kw">c</span>(<span class="st">'record_id'</span>, <span class="st">'mod_id'</span>, <span class="st">'mod_visit'</span>, <span class="st">'mod_id_visit'</span>, <span class="st">'samp'</span>),
    <span class="dt">orderBy =</span> <span class="st">'record_id'</span>,
    <span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(conc.cln)</code></pre></div>
<pre><code>##   record_id mod_id mod_visit mod_id_visit samp fentanyl_calc_conc
## 1         1      1         2          1.2    1         0.01413622
## 2         2      1         2          1.2    2         0.27982075
## 3         3      2         1          2.1    1         6.11873679
## 4         4      2         1          2.1    2         0.59161716
## 5         5      2         1          2.1    3         0.11280471
## 6         6      2         1          2.1    4         0.02112153</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(conc.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_conc_mod_id.rds&quot;</span>))

## dosing data
<span class="co"># flow</span>
flow.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(flow.in, mod.id,
    <span class="dt">firstCols =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>, <span class="st">'mod_visit'</span>, <span class="st">'mod_id_visit'</span>),
    <span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(flow.cln)</code></pre></div>
<pre><code>##   mod_id mod_visit mod_id_visit     Perform.Date FOCUS_MEDNAME Final.Wt..kg.
## 1      9         1          9.1   12/4/2016 5:30      Fentanyl          6.75
## 2      9         1          9.1   12/4/2016 6:00      Fentanyl          6.75
## 3      9         1          9.1   12/4/2016 7:00      Fentanyl          6.75
## 4      9         1          9.1   12/4/2016 7:40      Fentanyl          6.75
## 5     10         1         10.1 12/24/2016 19:30      Fentanyl          2.60
## 6     10         1         10.1 12/24/2016 20:00      Fentanyl          2.60
##   Final.Rate..NFR.units. Final.Units Flow
## 1            1 mcg/kg/hr       3.375   NA
## 2            1 mcg/kg/hr       6.750  0.1
## 3            1 mcg/kg/hr       4.500  0.1
## 4            0 mcg/kg/hr       0.000   NA
## 5            2 mcg/kg/hr       2.600   NA
## 6            2 mcg/kg/hr       5.200  0.2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(flow.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_flow_mod_id.rds&quot;</span>))

<span class="co"># mar</span>
mar.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(mar.in, mod.id, <span class="dt">firstCols =</span> <span class="st">'mod_id'</span>, <span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(mar.cln)</code></pre></div>
<pre><code>##   mod_id       Date  Time                 med:mDrug   med:dosage med:route
## 1      1 2017-02-04 19:15               Nicardipine 3 mcg/kg/min        IV
## 2      1 2011-10-02 22:11                Famotidine       4.5 mg        IV
## 3      1 2011-10-02 20:17          Morphine sulfate         1 mg        IV
## 4      1 2011-10-03 02:28 Diphenhydramine injection        12 mg        IV
## 5      1 2011-10-02 22:11                 Cefazolin       225 mg        IV
## 6      1 2011-10-02 23:30          Morphine sulfate         1 mg        IV
##   med:freq med:given
## 1     &lt;NA&gt;     Given
## 2   q12hrs     Given
## 3  q2h prn     Given
## 4      now     Given
## 5    q8hrs     Given
## 6  q2h prn     Given</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(mar.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_mar_mod_id.rds&quot;</span>))

## laboratory data
creat.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(creat.in, mod.id, <span class="st">'mod_id'</span>,<span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(creat.cln)</code></pre></div>
<pre><code>##   mod_id     date time creat
## 1      1 02/05/17 4:00  0.52
## 2      1 02/06/17 5:00  0.53
## 3      1 10/03/11 4:28  0.42
## 4      1 10/04/11 4:15  0.35
## 5      1 10/06/11 4:25  0.29
## 6      1 10/09/11 4:45  0.28</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alb.cln &lt;-<span class="st"> </span><span class="kw">pullFakeId</span>(alb.in, mod.id, <span class="st">'mod_id'</span>, <span class="dt">uniq.id =</span> <span class="st">'subject_uid'</span>)
<span class="kw">head</span>(alb.cln)</code></pre></div>
<pre><code>##   mod_id     date  time alb
## 1      8 07/30/20  5:23 2.9
## 2      8 07/28/20  3:12 2.0
## 3      8 07/29/20  1:39 2.7
## 4      8 08/21/20 10:35 4.1
## 5      4 06/13/15 17:20 4.1
## 6      6 07/25/16  8:35 2.3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(creat.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_creat_mod_id.rds&quot;</span>))
<span class="kw">saveRDS</span>(alb.cln, <span class="dt">file=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_alb_mod_id.rds&quot;</span>))</code></pre></div>
<p>Before running the processing modules, it is necessary to define several options and parameters. Using <code>options(pkxwalk =)</code> allows the modules to access the crosswalk file. We also create a <code>drugname</code> stub and define the lower limit of quantification (LLOQ) for the drug of interest.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set crosswalk option </span>
xwalk &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">file.path</span>(dataDir, <span class="st">&quot;Fentanyl_module_id.rds&quot;</span>))
<span class="kw">options</span>(<span class="dt">pkxwalk =</span> <span class="st">'xwalk'</span>)

<span class="co"># define parameters</span>
drugname &lt;-<span class="st"> 'fent'</span>
LLOQ &lt;-<span class="st"> </span><span class="fl">0.05</span></code></pre></div>
</div>
</div>
<div id="pro-demographic" class="section level2">
<h2>Pro-Demographic</h2>
<p>The <em>Pro-Demographic</em> module accepts the cleaned structured demographic dataset and a user-defined set of exclusion criteria and returns a formatted list with the demographic data and records meeting the exclusion criteria suitable for integration with the other modules. For this example, we exclude subjects with a value of 1 for <code>in_hospital_mortality</code> or <code>add_ecmo</code> and create a new variable called <code>length_of_icu_stay</code>.</p>
<p>The demographic data can be processed by the <code>run_Demo()</code> function using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># helper function</span>
exclude_val &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">val=</span><span class="dv">1</span>) { <span class="op">!</span><span class="kw">is.na</span>(x) <span class="op">&amp;</span><span class="st"> </span>x <span class="op">==</span><span class="st"> </span>val }

demo.out &lt;-<span class="st"> </span><span class="kw">run_Demo</span>(<span class="dt">demo.path =</span> <span class="kw">file.path</span>(dataDir, <span class="st">&quot;Fentanyl_demo_mod_id.rds&quot;</span>),
    <span class="dt">toexclude =</span> <span class="kw">expression</span>(<span class="kw">exclude_val</span>(in_hospital_mortality) <span class="op">|</span><span class="st"> </span><span class="kw">exclude_val</span>(add_ecmo)),
    <span class="dt">demo.mod.list =</span> <span class="kw">list</span>(<span class="dt">length_of_icu_stay =</span> 
                        <span class="kw">expression</span>(<span class="kw">daysDiff</span>(surgery_date, date_icu_dc))))</code></pre></div>
<pre><code>## The number of subjects in the demographic data, who meet the exclusion criteria: 2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(demo.out<span class="op">$</span>demo)</code></pre></div>
<pre><code>##   mod_id mod_visit mod_id_visit gender weight height surgery_date ageatsurgery
## 1      2         1          2.1      0   5.14  59.18    6/28/2014          141
## 2      3         1          3.1      1   5.67  62.90    1/10/2016          292
## 3      4         1          4.1      0  23.67 118.02    3/19/2016         2591
## 4      5         1          5.1      0  14.07  97.04    7/18/2016         1320
## 5      6         1          6.1      1  23.40 102.80    7/23/2016         1561
## 6      7         1          7.1      1   6.21  62.03     9/4/2016          208
##   stat_sts cpb_sts in_hospital_mortality add_ecmo date_icu_dc time_fromor
## 1        3     133                     0        0    7/2/2014        1657
## 2        1      65                     0        0   1/12/2016        1325
## 3        2     357                     0        0   3/20/2016          NA
## 4        5      93                     0        0   7/19/2016        1745
## 5        3      87                     1        0   7/30/2016        1847
## 6        1     203                     0        0   9/11/2016        1210
##   length_of_icu_stay
## 1                  4
## 2                  2
## 3                  1
## 4                  1
## 5                  7
## 6                  7</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">demo.out<span class="op">$</span>exclude</code></pre></div>
<pre><code>## [1] &quot;6.1&quot;  &quot;13.1&quot;</code></pre>
<ul>
<li>The <code>run_Demo</code> function arguments are as follows:
<ul>
<li><code>demo.path</code>: file path where cleaned demographic data exist</li>
<li><code>toexclude</code>: (optional) a set of user-defined expressions to set exclusion rules to be applied to the demographic dataset within the module</li>
<li><code>demo.mod.list</code>: (optional) a list of user defined expressions to set modification rules within the module</li>
</ul></li>
</ul>
<p>See the <code>run_Demo()</code> function documentation for more details on the optional arguments.</p>
<ul>
<li>The output of <code>run_Demo()</code> is a list with two components: <code>demo</code>, a dataframe containing a demogrpahic information and <code>exclude</code>, vector of excluded visit IDs.</li>
</ul>
</div>
<div id="pro-med-str" class="section level2">
<h2>Pro-Med-Str</h2>
<p>The <em>Pro-Med-Str</em> module processes structured medication data. Part I handles IV dose data and Part II handles e-prescription data.</p>
<div id="part-i-iv-dose-data" class="section level3">
<h3>Part I: IV dose data</h3>
<p>Part I handles IV dose data from two sources, Flow data and Medication Administration Records (MAR) data. The Flow data are patient flow sheets which at this institution record infusion rates and changes to all infusions for all inpatients outside of the operating room. The MAR data record all bolus doses of medications and infusions administered in the operating room. The module is semi-interactive; it generates several files to check potential data errors and get feedback from an investigator. If corrected information ('fix' files) are provided, the module should be re-run to incorporate the corrections. The major functions of this module are:</p>
<ul>
<li><p>Process and clean Flow data by selecting, renaming, and modifying variables with the <code>flow.select</code>, <code>flow.rename</code>, and <code>flow.mod.list</code> parameters, and remove duplicate records, including invalid duplicate rows with <code>final.units</code> of 0, rate missing, one rate or unit missing, one unit of 0, or additional discrepancy.</p></li>
<li>Process MAR data using the given medications in the <code>medchk.path</code> file, infusion units, bolus units, and bolus rate threshold. If there are data rows containing units other than those specified, a file listing these records will be produced using the <code>failunit_fn</code> stub appended with drugname.
<ul>
<li>e.g., if failunit_fn is 'Unit' the file 'failUnit-fent.csv' will be created in the <code>check.path</code> directory. The corrected file should replace 'fail' with 'fix' (e.g., 'fixUnit-fent.csv'), and include an additional variable called 'flag' with the value 'keep' for the records to be retained.</li>
</ul></li>
<li><p>Check for records with a unit containing 'kg' (e.g., 'mcg/kg/hr') but missing weight in flow data. These records will result in a calculated rate of NA when producing standardized rates (see step below). If there are records with missing weight, a file listing these records will be produced using the <code>failnowgt_fn</code> stub appended with drugname. A 'fix' file can be added to correct these records.</p></li>
<li><p>Combine Flow and MAR infusion data and produce standardized rate (dose per unit time). Infusion rates with dose per weight per unit time (e.g., 'mcg/kg/hr') and dose per unit time ('mcg/hr') can both be handled. For infusion rates of dose per weight per unit time, weight is imputed using the closest available Flow weight (if possible) and the rate is multiplied by weight to get dose per unit time. Infusion rates of dose per unit time are assumed to be formatted correctly.</p></li>
<li><p>Merge infusion dose data and bolus dose data and conform doses. See the <code>pkdata::conformDoses()</code> documentation for additional details.</p></li>
</ul>
<p>The IV dose data can be processed by the <code>run_MedStrI()</code> function using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ivdose.out &lt;-<span class="st"> </span><span class="kw">run_MedStrI</span>(<span class="dt">flow.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_flow_mod_id.rds&quot;</span>), 
    <span class="dt">flow.select =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>,<span class="st">'mod_id_visit'</span>,<span class="st">'Perform.Date'</span>,<span class="st">'Final.Wt..kg.'</span>,
                    <span class="st">'Final.Rate..NFR.units.'</span>,<span class="st">'Final.Units'</span>),
    <span class="dt">flow.rename =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>,<span class="st">'mod_id_visit'</span>, <span class="st">'Perform.Date'</span>, <span class="st">'weight'</span>,
                    <span class="st">'rate'</span>, <span class="st">'final.units'</span>),
    <span class="dt">flow.mod.list =</span> <span class="kw">list</span>(
      <span class="dt">date.time =</span> <span class="kw">expression</span>(<span class="kw">parse_dates</span>(<span class="kw">fixDates</span>(Perform.Date))),
      <span class="dt">unit =</span> <span class="kw">expression</span>(<span class="kw">sub</span>(<span class="st">'.*[ ]'</span>, <span class="st">''</span>, rate)),
      <span class="dt">rate =</span> <span class="kw">expression</span>(<span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">'([0-9.]+).*'</span>, <span class="st">'</span><span class="ch">\\</span><span class="st">1'</span>, rate)))),
    <span class="dt">medchk.path=</span><span class="kw">file.path</span>(rawDataDir, <span class="kw">sprintf</span>(<span class="st">'medChecked-%s.csv'</span>, drugname)), 
    <span class="dt">mar.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_mar_mod_id.rds&quot;</span>),
    <span class="dt">demo.list=</span>demo.out,
    <span class="dt">check.path=</span>checkDir, 
    <span class="dt">failflow_fn =</span> <span class="st">'FailFlow'</span>,
    <span class="dt">failunit_fn =</span> <span class="st">'Unit'</span>,
    <span class="dt">failnowgt_fn =</span> <span class="st">'NoWgt'</span>,
    <span class="dt">infusion.unit =</span> <span class="st">'mcg/kg/hr'</span>,
    <span class="dt">bolus.unit =</span> <span class="st">'mcg'</span>,
    <span class="dt">bol.rate.thresh =</span> <span class="ot">Inf</span>,
    <span class="dt">drugname =</span> drugname)</code></pre></div>
<pre><code>## The number of rows in the original data                124
## The number of rows after removing the duplicates       124
## no units other than mcg/kg/hr or mcg, file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/failUnit-fent.csv not 
##      created
## #########################
## 33 rows from 1 subjects with &quot;kg&quot; in infusion unit but missing weight, 
##      see file /var/folders/06/0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/
##      check2/failNoWgt-fent.csv AND create /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/fixNoWgt-fent.csv
## #########################</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(ivdose.out)</code></pre></div>
<pre><code>##   mod_id  date.dose infuse.time.real infuse.time infuse.dose
## 1      1 2011-10-02             &lt;NA&gt;        &lt;NA&gt;          NA
## 2      1 2011-10-02             &lt;NA&gt;        &lt;NA&gt;          NA
## 3      1 2017-02-04             &lt;NA&gt;        &lt;NA&gt;          NA
## 4      1 2017-02-04             &lt;NA&gt;        &lt;NA&gt;          NA
## 5      1 2017-02-04             &lt;NA&gt;        &lt;NA&gt;          NA
## 6      2 2014-06-28             &lt;NA&gt;        &lt;NA&gt;          NA
##            bolus.time bolus.dose given.dose maxint weight
## 1 2011-10-02 15:35:00         25         NA      0     NA
## 2 2011-10-02 17:26:00         25         NA      0     NA
## 3 2017-02-04 16:15:00         50         NA      0     NA
## 4 2017-02-04 16:30:00         20         NA      0     NA
## 5 2017-02-04 20:57:00         20         NA      0     NA
## 6 2014-06-28 08:15:00         20         NA      0     NA</code></pre>
<ul>
<li>The <code>run_MedStrI</code> function arguments are as follows:
<ul>
<li><code>flow.path</code>: file path where Flow data exist</li>
<li><code>flow.select</code>: list of variables in the Flow data, which are used for processing</li>
<li><code>flow.rename</code>: rename variables for the variables in flow.select</li>
<li><code>flow.mod.list</code>: list containing modifications to variables in the Flow data</li>
<li><code>medchk.path</code>: file path with list of medication names and variants in MAR data to be used</li>
<li><code>mar.path</code>: file path where the MAR data exist</li>
<li><code>demo.list</code>: (optional) file name for processed demographic file that is used to exclude subjects based on exclusion criteria</li>
<li><code>check.path</code>: file path where the generated files for data checking are stored, and the corresponding data files with fixed data exist</li>
<li><code>failflow_fn</code>: filename stub for invalid duplicate rows in the Flow data with rate of 0 check file. The stub will be prepended with the string 'fail' to create a .csv with the invalida data. The corrected data with failures replaced should use the same filename stub prepended with the string 'fix'.
<ul>
<li>e.g., if <code>failflow_fn</code> is 'FailFlow', the file 'failFailFlow.csv' with invalid duplicate rows will be created in the directory specified by <code>check.path</code>. The corrected version named 'fixFailFlow.csv' should be placed in the same directory.</li>
</ul></li>
<li><code>failunit_fn</code>: filename stub for records with units other than those specified with <code>infusion.unit</code> and <code>bolus.unit</code></li>
<li><code>failnowgt_fn</code>: filename stub for records with missing weight in the Flow data and unit involving 'kg'</li>
<li><code>infusion.unit</code>: string specifying units for infusion doses (default: 'mcg/kg/hr')</li>
<li><code>bolus.unit</code>: string specifying units for bolus doses (default: 'mcg')</li>
<li><code>bol.rate.thresh</code>: upper bound for retaining bolus doses. Bolus units with a rate above the threshold are dropped (default: Inf; i.e., keep all bolus doses)</li>
<li><code>drugname</code>: drug name of interest (e.g., dex, fent)</li>
</ul></li>
<li>The output of the <code>run_MedStrI</code> function is a dataset with processed IV dosing data including date (date.dose), infusion dose time (infuse.time.real and infuse.time) and rate (infuse.dose), bolus dose time (bolus.time) and dose level (bolus.dose), weight used in dose calculation and identification numbers for further merging with the output from other modules.</li>
</ul>
</div>
<div id="part-ii-e-prescription-data" class="section level3">
<h3>Part II: e-prescription data</h3>
<p>Part II handles e-prescription data. To use this module, all prescriptions must be for only one drug. Different names, such as brand names and generic names, for the same drug are allowed (e.g., Lamictal and lamotrigine). The data used in this module must include columns for ID, date, strength, dose amount, and frequency. The major tasks the module performs are as follows:</p>
<ul>
<li>Creating numeric variables for strength, dose, and frequency</li>
<li>Calculating daily dose</li>
<li>Removing duplicate daily doses for a patient</li>
</ul>
<p>There are two underlying functions used in this module. <code>processErx</code> performs the basic cleaning described above. <code>processErxAddl</code> performs some additional processing for more complicated dose expressions.</p>
<p>Below is example e-prescription data including columns for ID, drug name, dose, frequency, date, strength, and description.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(eRX &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(rawDataDir,<span class="st">&quot;e-rx_DATA.csv&quot;</span>),<span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>))</code></pre></div>
<pre><code>##   GRID    MED_NAME   RX_DOSE             FREQUENCY ENTRY_DATE STRENGTH_AMOUNT
## 1  ID1 lamotrigine         1                   bid 2009-02-24             100
## 2  ID2 lamotrigine         2                   bid 2006-12-30             100
## 3  ID2    Lamictal         1                   bid 2006-12-30             200
## 4  ID3 Lamictal XR         3                   bid 2004-08-24                
## 5  ID4 lamotrigine         1           twice a day 2010-05-22          200 mg
## 6  ID5 lamotrigine    2 tabs                   qam 2007-06-13             200
## 7  ID6 lamotrigine 1.5+1+1.5 brkfst, lunch, dinner 2015-03-14             100
##                                          DESCRIPTION
## 1 lamotrigine 100 mg tablet (Also Known As Lamictal)
## 2 lamotrigine 100 mg tablet (Also Known As Lamictal)
## 3                             LaMICtal 200 mg tablet
## 4                       Lamictal XR 100 mg 24 hr Tab
## 5 lamotrigine 200 mg tablet (Also Known As Lamictal)
## 6         LaMICtal XR 200 mg tablet,extended release
## 7 lamoTRIgine 100 mg tablet (Also Known As Lamictal)</code></pre>
<p>The e-prescription data can be processed by the <code>run_MedStrII</code> function using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eRX.out &lt;-<span class="st"> </span><span class="kw">run_MedStrII</span>(<span class="kw">file.path</span>(rawDataDir,<span class="st">&quot;e-rx_DATA.csv&quot;</span>),
    <span class="dt">select =</span> <span class="kw">c</span>(<span class="st">'GRID'</span>,<span class="st">'MED_NAME'</span>,<span class="st">'RX_DOSE'</span>,<span class="st">'FREQUENCY'</span>,<span class="st">'ENTRY_DATE'</span>,<span class="st">'STRENGTH_AMOUNT'</span>,<span class="st">'DESCRIPTION'</span>),
    <span class="dt">rename =</span> <span class="kw">c</span>(<span class="st">'ID'</span>,<span class="st">'MED_NAME'</span>,<span class="st">'RX_DOSE'</span>,<span class="st">'FREQUENCY'</span>,<span class="st">'ENTRY_DATE'</span>,<span class="st">'STRENGTH_AMOUNT'</span>,<span class="st">'DESCRIPTION'</span>))

eRX.out</code></pre></div>
<pre><code>##    ID    MED_NAME   RX_DOSE             FREQUENCY ENTRY_DATE STRENGTH_AMOUNT
## 1 ID1 lamotrigine         1                   bid 2009-02-24             100
## 2 ID2 lamotrigine         2                   bid 2006-12-30             100
## 4 ID3 Lamictal XR         3                   bid 2004-08-24                
## 5 ID4 lamotrigine         1           twice a day 2010-05-22          200 mg
## 6 ID5 lamotrigine    2 tabs                   qam 2007-06-13             200
## 7 ID6 lamotrigine 1.5+1+1.5 brkfst, lunch, dinner 2015-03-14             100
##                                          DESCRIPTION strength freq.standard
## 1 lamotrigine 100 mg tablet (also known as lamictal)      100           bid
## 2 lamotrigine 100 mg tablet (also known as lamictal)      100           bid
## 4                       lamictal xr 100 mg 24 hr tab      100           bid
## 5 lamotrigine 200 mg tablet (also known as lamictal)      200           bid
## 6         lamictal xr 200 mg tablet,extended release      200            am
## 7 lamotrigine 100 mg tablet (also known as lamictal)      100           tid
##   freq.num dose daily.dose       date num_doses num_freqs
## 1        2    1        200 2009-02-24        NA        NA
## 2        2    2        400 2006-12-30        NA        NA
## 4        2    3        600 2004-08-24        NA        NA
## 5        2    1        400 2010-05-22        NA        NA
## 6        1    2        400 2007-06-13        NA        NA
## 7        3    4        400 2015-03-14         3         3</code></pre>
<p>The following arguments are used in the <code>run_MedStrII</code> function:</p>
<ul>
<li><code>file</code>: file name of prescription data</li>
<li><code>select</code>: the names of the columns to select</li>
<li><code>rename</code>: new column names; the default are the names required for the underlying functions, <code>processErx</code> and <code>processErxAddl</code></li>
</ul>
<p>In the above example, daily dose was calculated for the first 5 patients by multiplying strength*dose*freq.num, and a redundant daily dose was removed for the patient with ID2. In order to calculate a daily dose for the patient with ID3, the strength of 100 from the description was used because STRENGTH_AMOUNT was missing. For the patient with ID6, the dose amounts of 1.5, 1, and 1.5 are added together to get a dose of 4, and the daily dose is calculated as strength*dose.</p>
</div>
</div>
<div id="pro-drug-level" class="section level2">
<h2>Pro-Drug Level</h2>
<p>Pro-Drug Level module processes drug concentration data that can be merged with medication dose data and other types of data. This module is semi-interactive; it generates several files while processing in order to check missing data and potential data errors, and get feedback from an investigator. If corrected information ('fix' files) are provided, the module should be re-run to incorporate the corrections. The major functions of this module are:</p>
<ul>
<li><p>Combine drug concentration data with sampling time: This step is necessary only if the drug concentration data file does not contain the sampling time (i.e., the time when blood samples were drawn for drug concentration measurements). When this is the case, the sampling time should be obtained from a separate data file.</p></li>
<li>Check missing date/time for drug level measurements. If there are any missing dates, a file listing these records will be produced using the <code>failmiss_fn</code> stub appended with drugname. A 'fix' file can be added to correct these records. If no 'fix' file is provided, records with missing dates will be removed.
<ul>
<li>e.g., if <code>failmiss_fn</code> is 'MissingConcDate-', the file 'failMissingConcDate-dex.csv' will be created in the <code>check.path</code> directory. The file with corrected dates and times should replace 'fail' with 'fix' (e.g., 'fixMissingConcDate-dex.csv'), and be placed in the same <code>check.path</code> directory.</li>
</ul></li>
<li>Check for multiple sets of concentration data for the same subject, and keep the set of concentration data with the most drug concentration records above a lower limit of quantification (LLOQ). Data for subjects with multiple records, if any, is included in a file produced with the <code>multsets_fn</code> stub appended with the drugname and date.
<ul>
<li>e.g., if <code>multsets_fn</code> is 'multipleSetsConc-', the file 'multipleSetsConc-dex2020-07-15.csv' will be created in the <code>check.path</code> directory.</li>
</ul></li>
<li>Check duplicate concentration records on the same date/time. If there are any records with multiple concentrations on the same date/time, a file listing these records will be produced using the <code>faildup_fn</code> stub appended with drugname. A 'fix' file can be added to correct these records. If no 'fix' file is found, all duplicates are retained.
<ul>
<li>e.g., if <code>faildup_fn</code> is 'DuplicateConc-', the file 'failDuplicateConc-dex.csv' will be created in the <code>check.path</code> directory. The corrected file should replace 'fail' with 'fix', e.g. 'fixDuplicateConc-dex.csv', and include an additional variable called 'flag' with the value 'keep' for the records to be retained.</li>
</ul></li>
</ul>
<p>The drug concentration data can be processed by the <code>run_DrugLevel</code> function using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">conc.out &lt;-<span class="st"> </span><span class="kw">run_DrugLevel</span>(<span class="dt">conc.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_conc_mod_id.rds&quot;</span>),
    <span class="dt">conc.select=</span><span class="kw">c</span>(<span class="st">'mod_id'</span>,<span class="st">'mod_id_visit'</span>,<span class="st">'samp'</span>,<span class="st">'fentanyl_calc_conc'</span>),
    <span class="dt">conc.rename=</span><span class="kw">c</span>(<span class="dt">fentanyl_calc_conc =</span> <span class="st">'conc.level'</span>, <span class="dt">samp=</span> <span class="st">'event'</span>),
    <span class="dt">conc.mod.list=</span><span class="kw">list</span>(<span class="dt">mod_id_event =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(mod_id_visit, event, <span class="dt">sep =</span> <span class="st">'_'</span>))),
    <span class="dt">samp.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_samp_mod_id.rds&quot;</span>),
    <span class="dt">samp.mod.list=</span><span class="kw">list</span>(<span class="dt">mod_id_event =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(mod_id_visit, samp, <span class="dt">sep =</span> <span class="st">'_'</span>))),
    <span class="dt">check.path=</span>checkDir,
    <span class="dt">failmiss_fn =</span> <span class="st">'MissingConcDate-'</span>,
    <span class="dt">multsets_fn =</span> <span class="st">'multipleSetsConc-'</span>,
    <span class="dt">faildup_fn =</span> <span class="st">'DuplicateConc-'</span>,
    <span class="dt">drugname=</span>drugname,
    <span class="dt">LLOQ=</span>LLOQ,
    <span class="dt">demo.list=</span>demo.out)
<span class="kw">head</span>(conc.out)</code></pre></div>
<pre><code>## #########################
## 3 rows need review, see file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      failMissingConcDate-fent.csv AND create /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      fixMissingConcDate-fent.csv
## #########################
## subjects with concentration missing from sample file
##  mod_id mod_id_event
##       8        8.1_1
##       8        8.1_2
##       8        8.1_3
## 1 subjects have multiple sets of concentration data
## 16 total unique subjects ids (including multiple visits) currently in the 
##      concentration data
## 15 total unique subjects in the concentration data
## #########################
## 15 rows need review, see file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      multipleSetsConc-fent2021-06-08.csv
## #########################
## 15 total unique subjects ids (after excluding multiple visits) in the 
##      concentration data
## 15 total unique subjects in the concentration data</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(conc.out)</code></pre></div>
<pre><code>##    mod_id mod_id_visit event  conc.level mod_id_event           date.time eid
## 1       1          1.2     1 0.014136220        1.2_1 2017-02-03 10:46:00   1
## 2       1          1.2     2 0.279820752        1.2_2 2017-02-04 20:30:00   1
## 55     10         10.1     2 3.136047304       10.1_2 2016-12-24 18:00:00   1
## 56     10         10.1     9 0.004720171       10.1_9 2017-01-01 04:20:00   1
## 57     10         10.1    10 0.017136367      10.1_10 2017-01-02 04:42:00   1
## 58     10         10.1    12 0.006335571      10.1_12 2017-01-04 03:40:00   1</code></pre>
<p>The output provides a message that 3 rows are missing concentration date. The file 'failMissingConcDate-fent.csv' contains the 3 records with missing values for the <code>date.time</code> variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">( fail.miss.conc.date &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="kw">file.path</span>(checkDir,<span class="st">&quot;failMissingConcDate-fent.csv&quot;</span>)) )</code></pre></div>
<pre><code>##   subject_id subject_uid mod_id_event date.time
## 1       1566    35885929        8.1_1        NA
## 2       1566    35885929        8.1_2        NA
## 3       1566    35885929        8.1_3        NA</code></pre>
<p>We can correct the missing dates by providing an updated file called 'fixMissingConcDate-fent.csv' that contains the missing data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fail.miss.conc.date[,<span class="st">&quot;date.time&quot;</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;9/30/2016 09:32&quot;</span>,<span class="st">&quot;10/1/2016 19:20&quot;</span>,<span class="st">&quot;10/2/2016 02:04&quot;</span>)
fail.miss.conc.date</code></pre></div>
<pre><code>##   subject_id subject_uid mod_id_event       date.time
## 1       1566    35885929        8.1_1 9/30/2016 09:32
## 2       1566    35885929        8.1_2 10/1/2016 19:20
## 3       1566    35885929        8.1_3 10/2/2016 02:04</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv</span>(fail.miss.conc.date, <span class="kw">file.path</span>(checkDir,<span class="st">&quot;fixMissingConcDate-fent.csv&quot;</span>))</code></pre></div>
<p>After providing the updated file, the same <code>run_DrugLevel()</code> function should be re-run. The output now contains an additional message below the first message saying &quot;fixMissingConcDate-fent.csv read with failures replaced&quot;. The conc.out data.frame also contains 3 additional rows with the corrected data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">conc.out &lt;-<span class="st"> </span><span class="kw">run_DrugLevel</span>(<span class="dt">conc.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_conc_mod_id.rds&quot;</span>),
    <span class="dt">conc.select=</span><span class="kw">c</span>(<span class="st">'mod_id'</span>,<span class="st">'mod_id_visit'</span>,<span class="st">'samp'</span>,<span class="st">'fentanyl_calc_conc'</span>),
    <span class="dt">conc.rename=</span><span class="kw">c</span>(<span class="dt">fentanyl_calc_conc =</span> <span class="st">'conc.level'</span>, <span class="dt">samp=</span> <span class="st">'event'</span>),
    <span class="dt">conc.mod.list=</span><span class="kw">list</span>(<span class="dt">mod_id_event =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(mod_id_visit, event, <span class="dt">sep =</span> <span class="st">'_'</span>))),
    <span class="dt">samp.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_samp_mod_id.rds&quot;</span>),
    <span class="dt">samp.mod.list=</span><span class="kw">list</span>(<span class="dt">mod_id_event =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(mod_id_visit, samp, <span class="dt">sep =</span> <span class="st">'_'</span>))),
    <span class="dt">check.path=</span>checkDir,
    <span class="dt">failmiss_fn =</span> <span class="st">'MissingConcDate-'</span>,
    <span class="dt">multsets_fn =</span> <span class="st">'multipleSetsConc-'</span>,
    <span class="dt">faildup_fn =</span> <span class="st">'DuplicateConc-'</span>, 
    <span class="dt">drugname=</span>drugname,
    <span class="dt">LLOQ=</span>LLOQ,
    <span class="dt">demo.list=</span>demo.out)</code></pre></div>
<pre><code>## #########################
## 3 rows need review, see file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      failMissingConcDate-fent.csv AND create /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      fixMissingConcDate-fent.csv
## #########################
## file /var/folders/06/0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      fixMissingConcDate-fent.csv read with failures replaced
## subjects with concentration missing from sample file
## [1] mod_id       mod_id_event
## &lt;0 rows&gt; (or 0-length row.names)
## 1 subjects have multiple sets of concentration data
## 16 total unique subjects ids (including multiple visits) currently in the 
##      concentration data
## 15 total unique subjects in the concentration data
## #########################
## 15 rows need review, see file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/
##      multipleSetsConc-fent2021-06-08.csv
## #########################
## 15 total unique subjects ids (after excluding multiple visits) in the 
##      concentration data
## 15 total unique subjects in the concentration data</code></pre>
<ul>
<li>The <code>run_DrugLevel</code> function arguments are as follows:
<ul>
<li><code>samp.path</code>: file path where the sampling time data exist</li>
<li><code>samp.mod.list</code>: list containing modifications to variables in the sampling time data</li>
<li><code>conc.path</code>: file path where the drug concentration data exist</li>
<li><code>conc.select</code>: list of variables in the drug concentration data, which are used for processing</li>
<li><code>conc.rename</code>: rename variables for the variables in conc.select</li>
<li><code>conc.mod.list</code>: list containing modifications to variables in the drug concentration data</li>
<li><code>check.path</code>: file path where the generated files for data checking are stored, and the corresponding data files with fixed data exist</li>
<li><code>failmiss_fn</code>: filename stub for missing concentration date check file</li>
<li><code>multsets_fn</code>: filename stub for multiple sets of concentration data check file</li>
<li><code>faildup_fn</code>: filename stub for duplicate concentration check file</li>
<li><code>drugname</code>: drug name of interest (e.g., dex, fent)</li>
<li><code>LLOQ</code>: lower limit of quantification (LLOQ)
<ul>
<li>e.g., dexmedetomidine 0.005 ng/mL, fentanyl 0.05 ng/mL</li>
</ul></li>
<li><code>demo.list</code>: file name for processed demographic file that is used to exclude subjects based on exclusion criteria</li>
</ul></li>
<li>The output of the <code>run_DrugLevel</code> function is a dataset for processed drug concentration levels (conc.level) matched with date/time (date.time), as well as necessary identification numbers for further merging with the output from other modules.</li>
</ul>
</div>
<div id="pro-laboratory" class="section level2">
<h2>Pro-Laboratory</h2>
<p>The Pro-Laboratory module processes laboratory data that can be merged with data from other modules. The laboratory data can be processed using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">creat.out &lt;-<span class="st"> </span><span class="kw">run_Labs</span>(<span class="dt">lab.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_creat_mod_id.rds&quot;</span>),
    <span class="dt">lab.select =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>,<span class="st">'date.time'</span>,<span class="st">'creat'</span>),
    <span class="dt">lab.mod.list =</span> <span class="kw">list</span>(<span class="dt">date.time =</span> <span class="kw">expression</span>(<span class="kw">parse_dates</span>(<span class="kw">fixDates</span>(<span class="kw">paste</span>(date, time))))))

alb.out &lt;-<span class="st"> </span><span class="kw">run_Labs</span>(<span class="dt">lab.path=</span><span class="kw">file.path</span>(dataDir,<span class="st">&quot;Fentanyl_alb_mod_id.rds&quot;</span>),
    <span class="dt">lab.select =</span> <span class="kw">c</span>(<span class="st">'mod_id'</span>,<span class="st">'date.time'</span>,<span class="st">'alb'</span>),
    <span class="dt">lab.mod.list =</span> <span class="kw">list</span>(<span class="dt">date.time =</span> <span class="kw">expression</span>(<span class="kw">parse_dates</span>(<span class="kw">fixDates</span>(<span class="kw">paste</span>(date, time))))))

lab.out &lt;-<span class="st"> </span><span class="kw">list</span>(creat.out, alb.out)

<span class="kw">str</span>(lab.out)</code></pre></div>
<pre><code>## List of 2
##  $ :'data.frame':    266 obs. of  3 variables:
##   ..$ mod_id   : int [1:266] 1 1 1 1 1 1 1 1 1 1 ...
##   ..$ date.time: POSIXct[1:266], format: &quot;2017-02-05 04:00:00&quot; &quot;2017-02-06 05:00:00&quot; ...
##   ..$ creat    : num [1:266] 0.52 0.53 0.42 0.35 0.29 0.28 0.34 0.59 0.54 0.26 ...
##  $ :'data.frame':    44 obs. of  3 variables:
##   ..$ mod_id   : int [1:44] 8 8 8 8 4 6 6 9 10 10 ...
##   ..$ date.time: POSIXct[1:44], format: &quot;2020-07-30 05:23:00&quot; &quot;2020-07-28 03:12:00&quot; ...
##   ..$ alb      : num [1:44] 2.9 2 2.7 4.1 4.1 2.3 2.6 3 3.1 4.2 ...</code></pre>
<ul>
<li>The <code>run_Labs</code> function arguments are as follows:
<ul>
<li><code>lab.path</code>: file path where the laboratory data exist</li>
<li><code>lab.select</code>: list of variables in the laboratory data to be retained</li>
<li><code>lab.mod.list</code>: list containing modifications to variables in the laboratory data</li>
</ul></li>
</ul>
</div>
<div id="build-pk-iv" class="section level2">
<h2>Build-PK-IV</h2>
<p>The Build-PK-IV module creates PK data for IV medications. Both dose data from the <em>Pro-Med-Str1</em> module and concentration data from the <em>Pro-DrugLevel</em> module are required. Demographic data from the <em>Pro-Demographic</em> module and laboratory data from the <em>Pro-Laboratory</em> module may optionally be included. The module is semi-interactive; it generates several files to check potential data errors, and get feedback from an investigator. If corrected information (‘fix’ files) are provided, the module should be re-run to incorporate the corrections. The major functions this module performs are:</p>
<ul>
<li><p>Determine whether each IV dose is valid by comparing to concentration data. Doses outside the time frame window defined by concentration data (by default seven days before first concentration through last concentration) are dropped. See <code>pkdata::trimDoses()</code> for more information.</p></li>
<li>Resolve duplicate doses. A file with duplicate bolus dose records, if any, will be produced using the <code>faildupbol_fn</code> stub appended with drugname. A ‘fix’ file can be added to correct these records.
<ul>
<li>e.g., if <code>faildupbol_fn</code> is 'DuplicateBolus-', the file 'failDuplicateBolus-fent.csv' will be created in the <code>check.path</code> directory. The corrected file should replace 'fail' with 'fix' (e.g., 'fixDuplicateBolus-fent.csv'), and include an additional variable called 'flag' with the value 'keep' for the records to be retained.</li>
</ul></li>
<li><p>Add zero dose values after a gap.</p></li>
<li><p>If demographic data is provided, update the 'maxint' value.</p></li>
<li><p>Combine dose and concentration data into PK data format.</p></li>
<li><p>If laboratory data is provided, merge onto PK data based on ID and time.</p></li>
<li>If demographic data is provided, merge onto PK data. Demographic weight is used to impute records with missing dose weight. In addition, subjects who meet the exclusion criteria and those with no demographic data are removed. A file showing the missingness frequency and percent for each variable is produced using the <code>missdemo_fn</code> stub appended wih drugname.
<ul>
<li>e.g., if <code>missdemo_fn</code> is '-missing-demo', the file 'dex-missing-demo.csv' will be created in the <code>check.path</code> directory.</li>
</ul></li>
<li>The final PK data includes ID and standard NONMEM formatted variables:</li>
<li>time - time of dosing or concentration event</li>
<li>conc - observed concentration (NA for dosing records)</li>
<li>amt - dose amount administered (NA for concentration records)</li>
<li>rate - rate of drug administration (e.g., rate=0 for bolus doses)</li>
<li>mdv - missing dependent variable (dv) indicator (e.g., 0 = not missing dv, 1 = missing dv)</li>
<li><p>evid - event ID (e.g., 0 = observation, 1 = dose event)</p></li>
</ul>
<p>If demographic data is provided, the demographic variables named in <code>demo.vars</code> will also be included and renamed according to <code>demo.abbr</code>.</p>
<p>PK data with IV dosing can be built by the <code>run_Build_PK_IV</code> function using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pk_dat &lt;-<span class="st"> </span><span class="kw">run_Build_PK_IV</span>(<span class="dt">conc=</span>conc.out,
    <span class="dt">dose=</span>ivdose.out,
    <span class="dt">demo.list=</span>demo.out,
    <span class="dt">demo.vars=</span><span class="kw">c</span>(<span class="st">'weight'</span>, <span class="st">'weight_demo'</span>, <span class="st">'height'</span>, <span class="st">'gender'</span>,
                <span class="st">'ageatsurgery'</span>, <span class="st">'stat_sts'</span>, <span class="st">'cpb_sts'</span>,
                <span class="st">'length_of_icu_stay'</span>),
    <span class="dt">demo.abbr=</span><span class="kw">c</span>(<span class="st">'wgt'</span>, <span class="st">'wgt_demo'</span>, <span class="st">'height'</span>, <span class="st">'gender'</span>,
                <span class="st">'age'</span>, <span class="st">'stat'</span>, <span class="st">'cpb'</span>, <span class="st">'loi'</span>),
    <span class="dt">lab.dat =</span> lab.out,
    <span class="dt">lab.vars =</span> <span class="kw">c</span>(<span class="st">'creat'</span>,<span class="st">'alb'</span>),
    <span class="dt">pk.vars=</span><span class="kw">c</span>(<span class="st">'mod_id_visit'</span>, <span class="st">'time'</span>, <span class="st">'conc'</span>, <span class="st">'dose'</span>, <span class="st">'rate'</span>, <span class="st">'event'</span>,
              <span class="st">'other'</span>, <span class="st">'multiple.record'</span>, <span class="st">'date'</span>, <span class="st">'mod_id'</span>),
    <span class="dt">drugname=</span>drugname,
    <span class="dt">check.path=</span>checkDir,
    <span class="dt">missdemo_fn=</span><span class="st">'-missing-demo'</span>,
    <span class="dt">faildupbol_fn=</span><span class="st">'DuplicateBolus-'</span>,
    <span class="dt">date.format=</span><span class="st">&quot;%m/%d/%y %H:%M:%S&quot;</span>,
    <span class="dt">date.tz=</span><span class="st">&quot;America/Chicago&quot;</span>)</code></pre></div>
<pre><code>## 0 duplicated rows
## The dimension of the PK data before merging with demographics: 234 x 9
## The number of subjects in the PK data before merging with demographics: 15
## The number of subjects in the demographic file, who meet the exclusion 
##      criteria: 2
## check NA frequency in demographics, see file /var/folders/06/
##      0qv1dr5508j_tbzqdjfqjf680000gn/T//RtmpeLnMLA/check2/fent-missing-demo.csv
## List of IDs missing at least 1 cpb_sts: 12.1
## The list of final demographic variables: weight
## weight_demo
## height
## gender
## ageatsurgery
## stat_sts
## cpb_sts
## length_of_icu_stay
## Checked: there are no missing creat
## List of IDs missing at least 1 alb: 1.2
## 11.1
## 15.1
## 2.1
## 3.1
## 4.1
## 5.1
## 7.1
## 8.1
## The dimension of the final PK data exported with the key demographics: 
##      197 x 17 with 13 distinct subjects (mod_id_visit)</code></pre>
<p>The function <code>pullRealId()</code> appends the original IDs -- <code>subject_id</code> and <code>subject_uid</code> to the data. The parameter <code>remove.mod.id=TRUE</code> can be used to also remove any module IDs -- <code>mod_id</code>, <code>mod_visit</code>, and <code>mod_id_visit</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># convert id back to original IDs</span>
pk_dat &lt;-<span class="st"> </span><span class="kw">pullRealId</span>(pk_dat, <span class="dt">remove.mod.id=</span><span class="ot">TRUE</span>)

<span class="kw">head</span>(pk_dat)</code></pre></div>
<pre><code>##      subject_id subject_uid time      conc   amt rate mdv evid   wgt wgt_demo
## 2         466.1    28579217 0.00        NA  50.0  0.0   1    1 21.99    21.99
## 2.1       466.1    28579217 0.25        NA  20.0  0.0   1    1 21.99    21.99
## 2.2       466.1    28579217 4.25 0.2798208    NA   NA   0    0 21.99    21.99
## 12       1607.0    38551767 0.00        NA 109.2 10.4   1    1  2.60     2.76
## 12.1     1607.0    38551767 0.00        NA  10.0  0.0   1    1  2.60     2.76
## 12.2     1607.0    38551767 1.25        NA  15.0  0.0   1    1  2.60     2.76
##      height gender  age stat cpb loi creat alb
## 2    116.90      0 2451    1 107   1  0.54  NA
## 2.1  116.90      0 2451    1 107   1  0.54  NA
## 2.2  116.90      0 2451    1 107   1  0.54  NA
## 12    45.94      0   23    3 110  12  0.66 1.6
## 12.1  45.94      0   23    3 110  12  0.66 1.6
## 12.2  45.94      0   23    3 110  12  0.66 1.6</code></pre>
<ul>
<li>The <code>run_Build_PK_IV</code> function arguments are as follows:
<ul>
<li><code>conc</code>: concentration data output from run_DrugLevel (required)</li>
<li><code>dose</code>: IV dose data output from run_MedStrI (required)</li>
<li><code>demo.list</code>: (optional) file name for processed demographic file</li>
<li><code>demo.vars</code>: (optional) vector of demographic variables to include in final output</li>
<li><code>demo.abbr</code>: (optional) vector of abbreviations for demographic variables in <code>demo.vars</code></li>
<li><code>lab.dat</code>: (optional) list containing processed laboratory files</li>
<li><code>lab.vars</code>: (optional) vector containing names for laboratory files</li>
<li><code>pk.vars</code>: PK variables to include</li>
<li><code>drugname</code>: drug name stub (e.g., fent)</li>
<li><code>check.path</code>: file path where the generated files for data checking are stored, and the corresponding data files with fixed data exist</li>
<li><code>missdemo_fn</code>: filename stub for report of missingness frequency and percent for variables</li>
<li><code>faildupbol_fn</code>: filename stub for duplicate bolus dose records</li>
<li><code>date.format</code>: date and time format (e.g., &quot;%m/%d/%y %H:%M:%S&quot;)</li>
<li><code>date.tz</code>: date timezone (e.g., &quot;America/Chicago&quot;)</li>
</ul></li>
<li>The output of the <code>run_MedStrI</code> function is a dataset with NONMEM formatted PK variables and (optionally) demographic and laboratory data.</li>
</ul>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<ol style="list-style-type: decimal">
<li>Choi L, Beck C, McNeer E, Weeks HL, Williams ML, James NT, Niu X, Abou-Khalil BW, Birdwell KA, Roden DM, Stein CM. Development of a System for Post-marketing Population Pharmacokinetic and Pharmacodynamic Studies using Real-World Data from Electronic Health Records. Clinical Pharmacology &amp; Therapeutics. 2020 Apr; 107(4): 934-943.</li>
</ol>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
